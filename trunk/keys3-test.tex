% !TEX program  = pdflatex
\immediate\write18{tex keys3.ins}

\documentclass{article}
\usepackage{keys3,xparse}
\usepackage[parfill]{parskip}

% The document commands for creating keys is very simple. A generic
% one is created to set any modules keys, and one specific to the module 
% used here.
\ExplSyntaxOn
\DeclareDocumentCommand{\SetModuleKeys}{m}{
  \keys_manage:n{
    module~name/.cd:,
    #1}
}

\DeclareDocumentCommand{\SetKeys}{m}{
  \keys_manage:n{#1}
}

\ExplSyntaxOff

\begin{document}

% Each test starts with a short piece of text explaining the property
% being used. Under this, the expected output is given, followed
% if relevant by the text of any error messages expected.

% Test one: Simply creating a key with one argument and then using it.
% Notice that the text length determines the limits of the argument: 
% spaces at either end are ignored. Literal spaces between text are 
% counted, as are those enclosed in braces.
% ----------------------------------------------------------------------
%   You said: `Hello World'
%   You said: ` Hello World '
%   You said: `'
% ----------------------------------------------------------------------
\SetModuleKeys{
  key/.code:n = {You said: `#1'\\},
  key = Hello World ,
  key = { Hello World },
  key 
}

% Test two: Creating a multiple-argument key. Here, the arguments
% given need to be at least as many as those required by the code!
% ----------------------------------------------------------------------
%   You said: `A', `B', `C', D'.
%   You said: `AAA', `BBB', `CCC', ` DDD'.
%   You said: `', `', `', `'.
% ----------------------------------------------------------------------
\SetModuleKeys{
  key/.code:Nn = 4 {You said: `#1', `#2', `#3', `#4'.\\},
  key = ABCD,
  key = {AAA}{BBB} {CCC} { DDD},
  key =,
}

% Test three: The ability to change the key path is available with the
% .cd: property. The following moves from the key root to two separate
% paths, creating keys with the same names.
% ----------------------------------------------------------------------
%   A key in path one
%   A key in path two
%   A key in path two
%   A key in path one
% ----------------------------------------------------------------------
\SetKeys{
  /path one/.cd:,
  key/.code:n = A key in path one\\,
  /path two/.cd:,
  key/.code:n = A key in path two\\,
  /path one/key,
  /path two/key,
  key,
  /path one/.cd:,
  key
}

% Test four: Variants of .code:n and .code:Nn exist which carry out a
% full expansion on code definition. First the :x variant is tested.
% ----------------------------------------------------------------------
%   Temp holds: ABC
%   Temp hold: 123
% ----------------------------------------------------------------------
\newcommand*{\temp}{123}
\SetModuleKeys{
  key one/.code:n = Temp holds: \temp\\,
  key two/.code:x = Temp holds: \temp,
}
\renewcommand*{\temp}{ABC}
\SetModuleKeys{
  key one,
  key two
}
% Now the :Nx version
% ----------------------------------------------------------------------
%   Arguments: A, B. Temp holds: ABC
%   Arguments: 1, 2. Temp hold: 123
% ----------------------------------------------------------------------
\renewcommand*{\temp}{123}
\SetModuleKeys{
  key one/.code:Nn = 2 {Arguments: #1, #2. Temp holds: \temp\\},
  key two/.code:Nx = 2 {Arguments: #1, #2. Temp holds: \temp},
}

\renewcommand*{\temp}{ABC}
\SetModuleKeys{
  key one = {A} {B},
  key two = {1} {2}
}

% Test five: Values can be required and forbidden with the 
% .value required: and .value forbidden: properties.
% ----------------------------------------------------------------------
%   All okay
%   All okay
% ----------------------------------------------------------------------
% ! The key `/module name/key' cannot taken a value: the given input 
%   `Not allowed' is being ignored.
%  
% ! The key `/module name/key' requires a value and is being ignored.
% ----------------------------------------------------------------------
\SetModuleKeys{
  key/.code:n = {All okay\\},
  key/.value forbidden:,
  key,
  key = Not allowed,
  key/.code:n = #1,
  key/.value required:,
  key = {All okay},
  key
}

% Test six: Keys can be given a default value, to be used if nothing is
% specified by the user.
% ----------------------------------------------------------------------
%   Default
%   Real
%   Default
% ----------------------------------------------------------------------
\SetModuleKeys{
  key/.code:n = {#1\\},
  key/.default:n = Default,
  key,
  key = Real,
  key
}

\end{document}
